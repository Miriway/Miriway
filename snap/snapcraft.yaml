name: miriway
adopt-info: miriway
summary: A Mir/Wayland based desktop shell
description: A Mir/Wayland based desktop shell
confinement: classic
base: core22

architectures:
  - build-on: amd64
  - build-on: arm64
  - build-on: armhf

apps:
  miriway:
    command: &_command usr/local/bin/miriway
    environment: &_environment
      # Prep for Mir
      MIR_SERVER_PLATFORM_PATH: ${SNAP}/usr/lib/${SNAPCRAFT_ARCH_TRIPLET}/mir/server-platform
      __EGL_VENDOR_LIBRARY_DIRS: $SNAP/etc/glvnd/egl_vendor.d:$SNAP/usr/share/glvnd/egl_vendor.d
      LIBGL_DRIVERS_PATH: $SNAP/usr/lib/${SNAPCRAFT_ARCH_TRIPLET}/dri
      LIBINPUT_QUIRKS_DIR: ${SNAP}/usr/share/libinput
      PATH: ${SNAP}/usr/local/bin/:${PATH}
      # For "reasons" this is being set despite this being a classic snap. This overwrites the nonsense
      LD_LIBRARY_PATH: ""

  vnc-server:
    command-chain:
      - bin/miriway.vnc-server
    command: *_command
    environment: *_environment

  vnc-over-ssh:
    command: bin/miriway.vnc
    environment: *_environment

parts:
  mir:
    plugin: nil
    build-attributes:
      - enable-patchelf
    stage-snaps:
      - mir-libs/22/edge
    prime:
      - -*.h
      - -*.pc

  miriway:
    after: [mir]
    build-attributes:
      - enable-patchelf
    build-environment:
      - LD_LIBRARY_PATH: ${CRAFT_STAGE}/usr/lib/${CRAFT_ARCH_TRIPLET}
    override-build: |
      craftctl default
      server_version=`git -C ${SNAPCRAFT_PART_SRC} rev-list --count HEAD `
      mir_version=$( sed -rne 's/^version:\s+([^-]*)-.+$/\1/p' ${SNAPCRAFT_STAGE}/meta.mir-libs/snap.yaml )
      craftctl set version=$server_version-mir$mir_version
      if echo $mir_version | grep -e '+dev' -e '~rc' -q; then craftctl set grade=devel; else craftctl set grade=stable; fi
    plugin: cmake
    source: .
    build-packages:
      - pkg-config
      - libboost-filesystem-dev
      - libfreetype6-dev
      - libwayland-dev
      - libxkbcommon-dev
      - g++
      - make
    stage-packages:
      - libfreetype6
    prime:
      - -lib/udev
      - -usr/doc
      - -usr/doc-base
      - -usr/share/applications
      - -usr/share/apport
      - -usr/share/bug
      - -usr/share/doc
      - -usr/share/doc-base
      - -usr/share/icons
      - -usr/share/libdrm
      - -usr/share/libwacom
      - -usr/share/lintian
      - -usr/share/man
      - -usr/share/pkgconfig
      - -etc/xdg/xdg-miriway/miriway-shell.config-snap

  snap-utils:
    plugin: dump
    source: snap-utils

  mesa-patchelf:
    build-attributes:
      - enable-patchelf
    plugin: nil
    stage-packages:
    - libgl1-mesa-dri
    - libtinfo5
    # included in this part because it tries to pull in mesa bits
    - gvncviewer
    - swaybg
    - synapse
    - xvfb
    - xwayland
    stage:
      # The libraries in .../dri need no-patchelf, so they come from the mesa-unpatched part
      - -usr/lib/${SNAPCRAFT_ARCH_TRIPLET}/dri

  yambar:
    build-attributes:
      - enable-patchelf
    plugin: meson
    meson-parameters:
      - -Dbackend-x11=disabled
      - -Dbackend-wayland=enabled
    build-packages:
      - meson
      - ninja-build
      - wayland-protocols
      - libasound2-dev
      - libfcft-dev
      - libfontconfig-dev
      - libharfbuzz-dev
      - libinotifytools0-dev
      - libjson-c-dev
      - libmpdclient-dev
      - libpixman-1-dev
      - libtllist-dev
      - libudev-dev
      - libwayland-dev
      - libyaml-dev
      - scdoc
      - flex
      - bison
    source: https://codeberg.org/dnkl/yambar.git
    source-tag: 1.9.0
    source-depth: 1
    stage-packages:
      - fonts-font-awesome
      - fonts-ubuntu
      - libasound2
      - libfcft4
      - libjson-c5
      - libmpdclient2
      - libpixman-1-0
      - libudev1
      - libwayland-client0
      - libwayland-cursor0
      - libyaml-0-2
    stage:
      # The libraries in .../dri need no-patchelf, so they must come from the mesa-unpatched part
      - -usr/lib/${SNAPCRAFT_ARCH_TRIPLET}/dri

  mesa-no-patchelf:
    plugin: nil
    stage-packages:
      - libgl1-mesa-dri
    build-attributes:
      - no-patchelf # Otherwise snapcraft may strip the build ID and cause the driver to crash
    stage:
      # Only the libraries in .../dri need to not be patched, the rest come from the mesa part
      - usr/lib/${SNAPCRAFT_ARCH_TRIPLET}/dri
